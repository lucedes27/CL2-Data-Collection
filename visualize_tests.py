import carla
import time
import numpy as np

x_positions_kin = [0.0, 0.09485289983358218, 0.2837272351280737, 0.5466400599573308, 0.9114024874037739,
                   1.362602167090213, 1.907998665028323, 2.5389847172055666, 3.263264648237128, 4.072876783380803,
                   4.969015061368007, 5.948604843480698, 7.013205661215909, 8.157463963382678, 9.372596331497693,
                   10.66339347023261, 12.027953512088635, 13.464004178365988, 14.969200617187788, 16.54104251167839,
                   18.1774679160378, 19.875219835057464, 21.615118933490344, 23.312416443694058, 24.846297251536175,
                   26.171931878368717, 27.31735639587008, 28.34555254783132, 29.32760391242466, 30.29016534691864,
                   31.250217299760664, 32.22572962027564, 33.23028795862091, 34.280769167325225, 35.390367156870795,
                   36.57368168256441, 37.8524384072617, 39.254588363113925, 40.78613995086276, 42.46841734779897,
                   44.11965634476149, 45.553993522536665, 46.76747302670903, 47.77709488130661, 48.59414205969741,
                   49.255549292033905, 49.8664318280608, 50.53329602486837, 51.34293531185511, 52.326128728643745,
                   53.484721094689455, 54.800773516959644, 56.234444497075195, 57.7390530433277, 59.26788142630263,
                   60.77424334820499, 62.20740596176565, 63.51746227096578, 64.65959427110485, 65.61190326989924,
                   66.3743640906555, 66.96065831055766, 67.38001416803752, 67.66588398369275, 67.82324711536349,
                   67.9066417110291, 67.94850042022344, 67.97270566534728, 67.98597074107968, 67.99234975791042,
                   67.99612787679675]
y_positions_kin = [1.2, 1.2004221588512747, 1.2023855847712916, 1.2066750127997197, 1.2147385402081694,
                   1.226527174848451, 1.2423674109919367, 1.2613031529574714, 1.2826753246050804, 1.3050168368268933,
                   1.3271262623878894, 1.3477219488251793, 1.3652901346695585, 1.377893785592752, 1.3835301001427358,
                   1.3783092420597376, 1.3579794262193219, 1.3190159304664923, 1.2620812119074651, 1.1958942781628408,
                   1.142168827717784, 1.1378760605945404, 1.228322455100131, 1.4483019767677612, 1.7946932797850992,
                   2.237449773470902, 2.729088458099352, 3.223864910652716, 3.685018736516956, 4.101001162789639,
                   4.463755784419155, 4.771761435541353, 5.0194982038495475, 5.19696697359866, 5.2992331627476394,
                   5.3193359179111095, 5.241732292830246, 5.041218362224759, 4.716142637946726, 4.241753667374236,
                   3.68668756806742, 3.159646803387972, 2.7242721452323617, 2.399532510115081, 2.1709607653350633,
                   2.011082382143187, 1.883951030209662, 1.7638507630331075, 1.6418460299752407, 1.52374128338729,
                   1.4203549235773412, 1.340720192330291, 1.2874900340112956, 1.2561577604214664, 1.240156796205057,
                   1.232878401475732, 1.2289503677934877, 1.2249023011119093, 1.2196718318668927, 1.2139823870940363,
                   1.20882599667646, 1.2045973315326453, 1.2014323827797604, 1.1992008822408438, 1.197944176615487,
                   1.1972637946926417, 1.1969197069578341, 1.1967192869182635, 1.1966091964365222, 1.196556211656444,
                   1.196524817009744]
theta_positions_kin = [0.0, 0.00032016617610067754, 0.0015866239436925342, 0.004159957868856694, 0.008278902987296033,
                       0.013260220545989434, 0.018411089400202304, 0.022764851748333297, 0.025596991633897406,
                       0.026559895867702188, 0.02567511326242615, 0.02325207172797977, 0.019537044670080918,
                       0.014598883573093885, 0.008271357144937505, -4.738800108743267e-06, -0.010550119554004424,
                       -0.02270722271976833, -0.03410144338422726, -0.03992450753268997, -0.03299880406200639,
                       -0.005498909064021855, 0.0470001037904244, 0.12408613489826259, 0.2201750170367072,
                       0.3223292052361046, 0.39969449569776755, 0.43178290501011274, 0.4352578564278575,
                       0.4187532243800873, 0.38617421518457323, 0.34074556475059975, 0.2843568753956555,
                       0.21813680956403791, 0.14423225859391522, 0.06471211092249747, -0.01868102938291205,
                       -0.10334545837938061, -0.18555824751892408, -0.26053523555177954, -0.3242357857261998,
                       -0.3534371613032384, -0.3475977809396202, -0.3253309071471709, -0.29935009472527563,
                       -0.2746256437715576, -0.24975972360243243, -0.2219597121242773, -0.18906983218820275,
                       -0.15156568438373905, -0.11285583095365227, -0.0771033581980686, -0.0482283138490317,
                       -0.027472993805866465, -0.014245331808678631, -0.006945428542671423, -0.0038688289008318743,
                       -0.0034749107432172277, -0.004356694784977317, -0.005385686836384282, -0.006113666497856959,
                       -0.0065809399998180565, -0.006882080004933012, -0.007080131751769833, -0.007188279508299775,
                       -0.007245674111354207, -0.007274588227674632, -0.007291370920910064, -0.007300568789569816,
                       -0.007304991931337771, -0.007307611628651654]

x_positions_oracle = [0.0, 0.0949044209427049, 0.28469315431256503, 0.5489533408864209, 0.9124606995569756,
                      1.361838102724023, 1.907392739111744, 2.5404023170404977, 3.264899585378589, 4.075218233259621,
                      4.972232449166891, 5.951868966845507, 7.01350649422687, 8.154040861446763, 9.372036063320563,
                      10.664701759000412, 12.030226957318488, 13.466598113155493, 14.972171781199643,
                      16.543198253061696, 18.17695458522499, 19.85679998636462, 21.525846692352246, 23.28563946974546,
                      25.042848095742418, 26.523234240438153, 27.699322504074658, 28.565103517379725,
                      29.160958138282886, 29.56525085318728, 30.01516364325396, 30.71381924436629, 31.67358212089928,
                      32.8680706788865, 34.073255334558844, 35.125493890869905, 36.24285291639426, 37.61243645518666,
                      39.222889917397644, 40.99132530277337, 42.66597965526586, 44.0712227708203, 45.23817612217762,
                      46.29221614504345, 47.379360291926574, 48.49215379256007, 49.46179550354369, 50.165494608568366,
                      50.60263082445013, 50.76211577410511, 50.93779245825718, 51.336133124365, 51.96493047986113,
                      52.82214673201989, 53.9097176788262, 55.162284781896304, 56.59561746207603, 58.30368705864089,
                      60.046105424262144, 61.80978812004823, 63.847159285922174, 66.15019989904471, 68.70740304991466,
                      71.49269548665201, 74.48117442679664, 77.65202711398986, 80.98744914748391, 84.4720069865188,
                      87.90881103198645, 87.90881103198645, 87.90881115804383]
y_positions_oracle = [1.2, 1.200415855211185, 1.2023530415645942, 1.2065118936749644, 1.2142649867433073,
                      1.2258165638398881, 1.241801279182138, 1.2615054898368827, 1.284226329796726, 1.30843271315948,
                      1.3327095850895447, 1.3554768261315733, 1.3752148384522445, 1.3898405350709635,
                      1.3961316201271634, 1.3890268169634183, 1.3617455415265194, 1.3075872507303918,
                      1.2253208759186838, 1.1289492733398925, 1.0557637948039849, 1.0619687773252224, 1.196885306945767,
                      1.479151032992594, 1.8741400063083908, 2.302447978770648, 2.7263058699810694, 3.144601318610625,
                      3.4921460941287865, 3.7258134371272313, 3.9686538766688466, 4.313998169149572, 4.7285150265001175,
                      5.149916618560578, 5.460201431339273, 5.598093790703562, 5.623671402374922, 5.564146693110387,
                      5.39433107714456, 5.097355773548717, 4.751755438419133, 4.471294487189439, 4.276938939214301,
                      4.095715162082769, 3.8466373531286084, 3.5134207569440825, 3.174290127988905, 2.9344854372109137,
                      2.799097378353908, 2.757342875104289, 2.6819925041038446, 2.4748336738618852, 2.137073998983283,
                      1.6591683528590015, 1.0420202424509613, 0.35250837572781896, -0.3682698557555023,
                      -1.1248451873648155, -1.7825283589128318, -2.3141978910775967, -2.803865852092252,
                      -3.2442714229314262, -3.6228733387205163, -3.9267720181731818, -4.148742439566864,
                      -4.284005343321486, -4.33004319012463, -4.286522021806836, -4.210170846178717, -4.210170846178717,
                      -4.210170844272686]
theta_positions_oracle = [0.0, 0.00031639294907751203, 0.001566217455374281, 0.004062422752532602, 0.008051891226253709,
                          0.01301249646177401, 0.01839341132183198, 0.02319374260144864, 0.02663482737708026,
                          0.028164233719990724, 0.027653398956701016, 0.025345011836318147, 0.02152711018080746,
                          0.01627547103502355, 0.009124538731530199, -0.0008300746416483646, -0.014520871029451257,
                          -0.03173808707830866, -0.04914074195212127, -0.05799068821567921, -0.04543210709715132,
                          -0.0014017987040976815, 0.07294317138614095, 0.15476366433058836, 0.23330581134830133,
                          0.3028766843789816, 0.36095904204112833, 0.42253993424565234, 0.46662266690284837,
                          0.48288859273833307, 0.48651623615241046, 0.4739641121776804, 0.43577908116192066,
                          0.37097366826499617, 0.28451883723642113, 0.18769311830416993, 0.08850151705367919,
                          -0.005712719502858742, -0.08832413969581623, -0.15972294172508558, -0.20567174227077736,
                          -0.20203396455629868, -0.1775618206195154, -0.17497033679556193, -0.20591167229204937,
                          -0.25998366473412415, -0.30521651513504516, -0.31560941073436083, -0.3112053611388155,
                          -0.3051173617255933, -0.3179211701073969, -0.3620272349696377, -0.41517208911297643,
                          -0.4643018011284975, -0.49675214154521696, -0.4996304955680718, -0.4703349255414048,
                          -0.41883557500283, -0.350524299485729, -0.2848257961768911, -0.2289347832933563,
                          -0.1786850371907823, -0.13464935010429677, -0.09612084114367661, -0.06132050178464743,
                          -0.029654055388233274, -0.0009459287566045262, 0.024968460824649395, 0.026090993975512212,
                          0.026090993975512212, 0.026090992963840563]

# Connect to CARLA
client = carla.Client('localhost', 2000)
client.set_timeout(2.0)
world = client.get_world()

# # CARLA Settings
# settings = world.get_settings()
# # Timing settings
# settings.synchronous_mode = True  # Enables synchronous mode
# TIME_STEP = 0.05  # Time step for synchronous mode
# settings.fixed_delta_seconds = TIME_STEP
# # Physics substep settings
# settings.substepping = True
# settings.max_substep_delta_time = 0.01
# settings.max_substeps = 10
# world.apply_settings(settings)

# Get the vehicle blueprint
blueprint_library = world.get_blueprint_library()
vehicle_bp = blueprint_library.find('vehicle.tesla.model3')

# Spawn the vehicle at the starting point
spawn_point = carla.Transform(carla.Location(x=x_positions_kin[0], y=y_positions_kin[0], z=1))
vehicle = world.spawn_actor(vehicle_bp, spawn_point)
vehicle.set_simulate_physics(False)


# Function to teleport the vehicle
def teleport_vehicle(vehicle, x, y, theta):
    transform = vehicle.get_transform()
    transform.location.x = x
    transform.location.y = y
    transform.rotation.yaw = np.degrees(theta)  # Convert radians to degrees for CARLA
    vehicle.set_transform(transform)


def move_spectator_to_vehicle(spectator, vehicle):
    transform = vehicle.get_transform()
    spectator.set_transform(carla.Transform(transform.location + carla.Location(z=20), carla.Rotation(pitch=-90)))


# Teleport the vehicle over time
for x, y, theta in zip(x_positions_kin, y_positions_kin, theta_positions_kin):
    teleport_vehicle(vehicle, x, y, theta)
    move_spectator_to_vehicle(world.get_spectator(), vehicle)
    print(f'Teleporting vehicle to x: {x}, y: {y}, theta: {theta}')
    time.sleep(0.1)
